function [RealSenseData] = CorrectRealSenseFrames(RealSenseData)
%________________________________________________________________________________________________________________________
% Written by Kevin L. Turner
% The Pennsylvania State University, Dept. of Biomedical Engineering
% https://github.com/KL-Turner
%________________________________________________________________________________________________________________________
%
%   Purpse:  
%________________________________________________________________________________________________________________________
%
%   Inputs: 
%
%   Outputs: 
%
%   Last Revised: May 12th, 2019
%________________________________________________________________________________________________________________________

%% Fill image holes with interpolated values, outside -> in
realsenseFrames = RealSenseData.depthMap;
allImgs = cell(length(realsenseFrames), 1);
for a = 1:length(realsenseFrames)
    disp(['Filling image holes... (' num2str(a) '/' num2str(length(realsenseFrames)) ')']); disp(' ') 
    image = realsenseFrames{a,1};
    onesIndeces = image >= 1;
    image(onesIndeces) = 0;
    zeroIndeces = image == 0;
    allImgs{a,1} = regionfill(image, zeroIndeces);
end
holeImgStack = cat(3, allImgs{:});

%% Kalman filter
disp('Running image stack though Kalman filter'); disp(' ')
correctedImgStack = Kalman_Stack_Filter(holeImgStack, 0.75, 0.75);
kalmanImgStack;

pixelMeans = mean(correctedImgStack, 3);
for b = 1:length(holeImgStack)
    disp('Mean subtracking and removing the background noise
    finalImgStack(:,:,b) = correctedImgStack(:,:,b) - pixelMeans;
end

% mean subtract
% set all below a thershold to zero
% overlay original image pixels

disp('Determining proper caxis scaling...'); disp(' ')
for c = 1:length(holeImgStack)
    tempImg = finalImgStack(:,:,c);
    tempMax(1,c) = max(tempImg(:));
    tempMin(1,c) = min(tempImg(:));
end

RealSenseData.correctedImageStack = finalImgStack;
RealSenseData.caxis = [mean(tempMin) mean(tempMax)];

end
